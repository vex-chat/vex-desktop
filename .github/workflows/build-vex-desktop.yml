name: Build vex-desktop
on:
    push:
        tags:
            - "v*"
permissions:
    contents: write
jobs:
    build:
        name: Build (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: windows-latest
                      builder_args: win
                    - os: ubuntu-latest
                      builder_args: linux
                    - os: macos-15-intel
                      builder_args: mac
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Install mise
              uses: jdx/mise-action@v3.5.1
              with:
                  cache: false

            - name: Configure node-gyp Python (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  echo "npm_config_python=$(mise which python)" >> $GITHUB_ENV

            - name: Setup MSBuild (Windows)
              if: runner.os == 'Windows'
              uses: microsoft/setup-msbuild@v2
              with:
                  vs-version: "[17.0,18.0)"

            - name: Configure node-gyp (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  $pythonPath = mise which python
                  echo "npm_config_python=$pythonPath" >> $env:GITHUB_ENV

            - name: Install bsdtar (for pacman target)
              if: runner.os == 'Linux'
              run: sudo apt-get update && sudo apt-get install -y libarchive-tools

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build
              run: yarn package-${{ matrix.builder_args }} --publish never

            - name: Show release contents (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  echo "Contents of release directory:"
                  Get-ChildItem -Path release -Recurse | Select-Object FullName

            - name: Show release contents (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  echo "Contents of release directory:"
                  ls -lhR release/

            - name: Upload artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: vex-desktop-${{ runner.os }}
                  if-no-files-found: error
                  path: |
                      release/*.exe
                      release/*.AppImage
                      release/*.deb
                      release/*.pacman
                      release/*.tar.gz
                      release/*.dmg
                      release/latest-linux.yml
                      release/latest-mac.yml
                      release/latest.yml

    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v7
              with:
                  path: ./artifacts

            - name: Create release and upload assets
              uses: softprops/action-gh-release@v2.5.0
              with:
                  tag_name: ${{ github.ref_name }}
                  name: ${{ github.ref_name }}
                  generate_release_notes: true
                  files: |
                      artifacts/**/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
